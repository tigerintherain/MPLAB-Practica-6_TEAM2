#define LCD_DATA_R          PORTD
#define LCD_DATA_W          LATD
#define LCD_DATA_DIR        TRISD
#define LCD_RS              LATCbits.LATC2
#define LCD_RS_DIR          TRISCbits.TRISC2
#define LCD_RW              LATCbits.LATC1
#define LCD_RW_DIR          TRISCbits.TRISC1
#define LCD_E               LATCbits.LATC0
#define LCD_E_DIR           TRISCbits.TRISC0
#include "device_config.h"
#include <stdlib.h>
#include <math.h>
#include <time.h>

//void declaration
void portsInit(void);
char key_scanner(void);
void LCD_init(void);

void main(void){
portsInit();
LCD_init();

while (1){

}

}

void portsInit (void){
    ANSELB = digital;   // Set port A as Digital for keypad driving
    TRISB  = 0xF0;      // For Port A, set pins 4 to 7 as inputs (columns), and pins 0 to 3 as outputs (rows)
    ANSELC = digital;   // Set port C as Digital
    TRISC = 0X00;       //RC0 to E, RC1 to R/W, RC2 to RS
    ANSELD = digital;   // Set port D as Digital
    TRISD = 0x00;       // Data bus (D0-D7)
}

char key_scanner(void){
    LATAbits.LB0 = 0;
    LATAbits.LB1 = 1;
    LATAbits.LB2 = 1;
    LATAbits.LB3 = 1;
    __delay_ms(SWEEP_FREQ);
    if      (PORTBbits.RB4 == 0) {__delay_ms(SWEEP_FREQ); return 1;}
    else if (PORTBbits.RB5 == 0) {__delay_ms(SWEEP_FREQ); return 2;}
    else if (PORTBbits.RB6 == 0) {__delay_ms(SWEEP_FREQ); return 3;}
    else if (PORTBbits.RB7 == 0) {__delay_ms(SWEEP_FREQ); return 10;}
    LATAbits.LB0 = 1;
    LATAbits.LB1 = 0;
    LATAbits.LB2 = 1;
    LATAbits.LB3 = 1;
    __delay_ms(SWEEP_FREQ);
    if      (PORTBbits.RB4 == 0) {__delay_ms(SWEEP_FREQ); return 4;}
    else if (PORTBbits.RB5 == 0) {__delay_ms(SWEEP_FREQ); return 5;}
    else if (PORTBbits.RB6 == 0) {__delay_ms(SWEEP_FREQ); return 6;}
    else if (PORTBbits.RB7 == 0) {__delay_ms(SWEEP_FREQ); return 11;}
    LATAbits.LB0 = 1;
    LATAbits.LB1 = 1;
    LATAbits.LB2 = 0;
    LATAbits.LB3 = 1;
    __delay_ms(SWEEP_FREQ);
    if      (PORTBbits.RB4 == 0) {__delay_ms(SWEEP_FREQ); return 7;}
    else if (PORTBbits.RB5 == 0) {__delay_ms(SWEEP_FREQ); return 8;}
    else if (PORTBbits.RB6 == 0) {__delay_ms(SWEEP_FREQ); return 9;}
    else if (PORTBbits.RB7 == 0) {__delay_ms(SWEEP_FREQ); return 12;}
    LATAbits.LB0 = 1;
    LATAbits.LB1 = 1;
    LATAbits.LB2 = 1;
    LATAbits.LB3 = 0;
    __delay_ms(SWEEP_FREQ);
    if      (PORTBbits.RB4 == 0) {__delay_ms(SWEEP_FREQ); return 14;}
    else if (PORTBbits.RB5 == 0) {__delay_ms(SWEEP_FREQ); return 0;}
    else if (PORTBbits.RB6 == 0) {__delay_ms(SWEEP_FREQ); return 15;}
    else if (PORTBbits.RB7 == 0) {__delay_ms(SWEEP_FREQ); return 13;}   
    else return 'x';
}

// LCD initialization function
void LCD_init(void){
    LATC = 0;               // Make sure LCD control port is low
    LCD_E_DIR = 0;          // Set Enable as output
    LCD_RS_DIR = 0;         // Set RS as output 
    LCD_RW_DIR = 0;         // Set R/W as output
    LCD_cmd(0x38);          // Display to 2x40
    LCD_cmd(0x0F);          // Display on, cursor on and blinking
    LCD_cmd(0x01);          // Clear display and move cursor home
}

// Send command to the LCD
void LCD_cmd(char cx) {
    LCD_rdy();              // wait until LCD is ready
    LCD_RS = 0;             // select IR register
    LCD_RW = 0;             // set WRITE mode
    LCD_E  = 1;             // set to clock data
    Nop();
    LCD_DATA_W = cx;        // send out command
    Nop();                  // No operation (small delay to lengthen E pulse)
    LCD_E = 0;              // complete external write cycle
}

// Function to display data on the LCD
void send2LCD(char xy){
    LCD_RS = 1;
    LCD_RW = 0;
    LCD_E  = 1;
    LCD_DATA_W = xy;
    Nop();
    Nop();
    LCD_E  = 0;
}
